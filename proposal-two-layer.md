# Исследование: Двухслойная архитектура спецификаций (Domain vs Implementation)

**Тип:** Explore Mode — черновик, живые файлы не изменяются
**Дата:** 2026-02-24
**Статус:** Предложение для обсуждения

---

## 1. Постановка проблемы

Когда AI-агент или человек проектирует систему, текущая структура спецификаций (один плоский слой) часто смешивает **фундаментальную суть идеи** (бизнес-логику, концептуальные правила) и **конкретную технологическую реализацию**.

Из-за этого возникает главная проблема — **потеря портативности (Portability)**:

1. Если мы детально описали концепт игры, приложения или сложной системы, он оказывается намертво привязан к выбранному стеку (например, Python, Unreal Engine, Bevy).
2. Невозможно легко взять и перенести "ядро", придуманное нами, в другую технологическую среду (например, игру с Unreal Engine на Godot или бэкенд с Python на Go). Абстрактные идеи неразрывно связаны с пакетами, фреймворками и специфичными API.

## 2. Концепция двух слоёв

При обработке идеи спецификации всегда делятся на два строгих концептуальных уровня:

### Layer 1 — Concept / Domain (Что это такое)

* **Суть:** Чистая идея, бизнес-правила, логика, механики, абстрактная архитектура.
* **Связь с технологиями:** Полностью агностик. Никаких упоминаний конкретных языков, фреймворков или пакетов (за исключением случаев, когда сама суть проекта лежит в технологии).
* **Главная ценность:** Весь Layer 1 можно «вырвать» из проекта, скопировать в абсолютно новый пустой проект с другим набором технологий, и он станет идеальным контрактом для генерации новых спецификаций реализации.

### Layer 2 — Implementation / Tech (Как мы это делаем здесь)

* **Суть:** Конкретная техническая реализация концепта из Layer 1 в рамках стека текущего проекта.
* **Связь с технологиями:** Жестко привязана к стеку (Go, Bevy, npm, базы данных и т.д.).
* **Главная ценность:** Описывает конкретные технические классы, интерфейсы, настройки. При смене стека Layer 2 просто выбрасывается, а на основе Layer 1 генерируется новый.

---

## 3. Пример: Проектирование компьютерной игры

Пользователь дает идею боевой системы. ИИ обрабатывает её в два этапа:

```text
.design/specifications/
├── combat-system.md              # [Layer 1] Чистый концепт: формулы урона, типы оружия, баланс, хитбоксы, математика.
├── combat-system-unreal.md       # [Layer 2] Реализация на Unreal Engine: Blueprints, интерфейсы C++, USTRUCT.
└── combat-system-bevy.md         # [Layer 2] Альтернатива: реализация в парадигме ECS: Systems, Components, Resources.
```

Если завтра мы решаем переписать игру с Unreal на Bevy, мы просто сохраняем `combat-system.md` (наш Layer 1). Перенос проекта между движками сводится к тому, что ИИ просят: *"Вот Layer 1 контракты, напиши для них спецификации Layer 2 под движок Bevy"*.

---

## 4. Жизненный цикл идеи (Как работает ИИ)

1. **Генерация смыслов:** Пользователь кидает набросок мыслей. ИИ-агент доводит его до ума и формирует полную **полноценную спецификацию Layer 1** (набор правил).
2. **Определение стека:** Агент смотрит на технологический стек текущего проекта (прописанный в `RULES.md` или `architecture.md`).
3. **Проектирование деталей:** На основе Layer 1 агент генерирует спецификацию(и) **Layer 2**, где описывает пакетную структуру, конкретные типы данных, API и архитектуру зависимостей именно для этого стека.

---

## 5. Интеграция в Magic SDD

Чтобы это заработало, нам **не нужно** менять файловую структуру (оставляем все в папке `specifications/`), но мы добавляем правила:

### 5.1 Метаданные в спецификациях

Обозначение слоев происходит через метаданные в начале файлов:

```markdown
# Combat System (Unreal Engine)

**Status:** Draft
**Layer:** implementation              ← Новое поле (concept | implementation)
**Implements:** combat-system.md       ← Ссылка на концепт Layer 1
```

### 5.2 Отражение в INDEX.md

Добавится колонка `Layer` для визуального понимания, какие документы универсальны, а какие — технические. У Layer 2 будут ссылки на родительские документы.

### 5.3 Планирование (PLAN.md)

План логически вытекает из слоёв:

```markdown
## Phase 0 — Concepts (Layer 1)
  - combat-system.md [L1]

## Phase 1 — Tech Implementation (Layer 2)
  - combat-system-unreal.md [L2 → combat-system.md]
```

Естественный гейт: нельзя начать реализовывать Layer 2, если его абстрактный концепт (Layer 1) не согласован и не находится в статусе Stable.
